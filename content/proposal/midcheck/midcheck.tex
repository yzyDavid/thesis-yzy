\cleardoublepage
\chapter{ä¸­æœŸæ£€æŸ¥}

\section{é¡¹ç›®æ¦‚å†µ}

æœ¬é¡¹ç›®åˆæ­¥å®Œæˆäº†å¼€å‘ç¯å¢ƒæ­å»ºï¼Œå¹¶ä¸”å¼€å§‹äº†è°ƒåº¦å™¨çš„å¼€å‘ä¸è°ƒä¼˜å·¥ä½œã€‚

\section{å·¥ä½œè¿›å±•æƒ…å†µ}

\subsection{Kubernetes ç¯å¢ƒæ­å»º}

Kubernetes é›†ç¾¤çš„åŸºæœ¬è¿è¡Œéœ€è¦ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

\subsubsection*{etcd}

etcd çš„å®˜æ–¹æè¿°ç§°ä¹‹ä¸º etc distributedã€‚å³å®ƒçš„åŠŸèƒ½ç›®æ ‡æ˜¯å°† UNIX ç³»ç»Ÿç›®å½•çš„ /etc åˆ†å¸ƒå¼ï¼Œä¸­å¿ƒåŒ–èµ·æ¥ã€‚å®é™…ä¸Šå®ƒçš„åŠŸèƒ½ä¸ Apache Zookeeper ç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é«˜å¯ç”¨çš„é”®å€¼å¯¹å­˜å‚¨æœåŠ¡ï¼Œæˆ–è€…ç§°ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ã€‚åœ¨ Kubernetes å½“ä¸­ï¼Œä¸€ä»½ k8s çš„ç³»ç»Ÿéƒ¨ç½²ä¼šå°†é›†ç¾¤çš„æ‰€æœ‰ä¿¡æ¯æŒä¹…åŒ–åœ¨ etcd å½“ä¸­ã€‚æ‰€ä»¥ä¸€å¥—å¯ç”¨çš„ k8s éƒ¨ç½²ä¸€å®šä¼šæœ‰ä¸€ä¸ª etcd é›†ç¾¤ã€‚

\subsubsection*{kube-apiserver}

API Server æ˜¯ç”¨æˆ·ä¸ k8s é›†ç¾¤çš„æ¡¥æ¢ï¼Œè´Ÿè´£æ¥å—ç”¨æˆ·æäº¤çš„ä»»åŠ¡ï¼Œå°†å…¶æŒä¹…åŒ–å¹¶ç­‰å¾…è°ƒåº¦ã€‚

\subsubsection*{kube-controller-manager}

Controller æ˜¯ k8s é›†ç¾¤ä¸­è´Ÿè´£è°ƒåº¦æŸä¸€ä¸ªåº”ç”¨éƒ¨ç½²çš„è§’è‰²ï¼Œä»–ä»¬æœ¬èº«éœ€è¦è¢«ä¸€ä¸ª Manager å»ç®¡ç†ï¼Œè¿™ä¸ª Manager ä¹Ÿå°±é—´æ¥èµ·åˆ°äº†ç®¡ç†æ•´ä¸ªé›†ç¾¤çš„åŠŸèƒ½ã€‚åŒæ ·çš„è¿™ä¸ªç®¡ç†è€…ä¹Ÿéœ€è¦èƒ½è·å– k8s é›†ç¾¤çš„éƒ¨ç½²ä¿¡æ¯ï¼Œå› æ­¤ä»–ä¹Ÿéœ€è¦è¿æ¥ API Serverã€‚å¯ä»¥è§å¾— API Server ä¸€å®šæ˜¯æ‰¿æ‹…äº†ä»¥ kubernetes é¢†åŸŸä¸“ç”¨çš„æ ¼å¼å’Œæƒé™ç®¡ç†çº¦å®šæš´éœ²æ•´ä¸ªé›†ç¾¤æ‰€æœ‰æ•°æ®çš„åŠŸèƒ½ã€‚

\subsubsection*{kubelet}

kubelet æ˜¯éœ€è¦éƒ¨ç½²åœ¨å—é›†ç¾¤ç®¡æ§çš„æ¯ä¸€å°æœºå™¨ä¸Šçš„ï¼Œå®ƒæ˜¯é›†ç¾¤ worker çš„ agent è§’è‰²ã€‚kubelet ä»¥ HTTP Server çš„æ–¹å¼å·¥ä½œï¼Œæ¥å—ç®¡ç†è€…å‘å‡ºçš„è¯·æ±‚æ¥æ‰§è¡Œå‘½ä»¤ã€‚

\subsubsection*{kube-proxy}

\subsubsection*{kube-scheduler}

\subsection{å¿«é€Ÿæ­å»ºæ–¹å¼}

å› ä¸ºä»é›¶å¼€å§‹æ­å»º kubernetes é›†ç¾¤å¯èƒ½å­˜åœ¨å¾ˆå¤šç»†èŠ‚é—®é¢˜ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ¡ä»¶éœ€æ±‚ï¼Œå¯¹åŸŸåï¼Œç½‘ç»œç­‰ç­‰æ¡ä»¶éƒ½æœ‰ä¾èµ–ï¼Œä¸”å·¥ä½œé‡å’Œè°ƒè¯•éš¾åº¦éƒ½ä¸ä½ã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬ä¹Ÿä»‹ç»ä¸€ä¸‹ä¸€äº›å·²æœ‰çš„å·¥å…·ï¼Œç”¨æ¥å¿«é€Ÿæ­å»ºé›†ç¾¤ã€‚å‡ºäºä¸åŒçš„ç›®çš„ï¼Œä¸¤ç§æ–¹å¼æˆ‘éƒ½è¿›è¡Œäº†å°è¯•ã€‚

\subsubsection{Docker in Docker æ–¹æ³•}

\subsubsection{minikube}

åœ¨ä¸€äº›åŸºæœ¬çš„é…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œminikube å¯èƒ½æ˜¯æœ€å®¹æ˜“æˆåŠŸè¿è¡Œçš„æ–¹å¼ã€‚å°½ç®¡å¦‚æ­¤ï¼Œè¿™ä¸ªæ‰€è°“çš„â€œå¼€ç®±å³ç”¨â€ä¹Ÿéœ€è¦ç¯å¢ƒæ»¡è¶³ä¸€äº›åŸºæœ¬è¦æ±‚ï¼Œä¾‹å¦‚å¯ä»¥è¿è¡Œ docker-machineã€‚

å…ˆåœ¨ä¸‹é¢ç»™å‡ºæœ¬äººæ­£ç¡®è¿è¡Œçš„æ–¹å¼ï¼š

å‘½ä»¤è¡Œï¼š

\begin{lstlisting}
sudo minikube config set vm-driver none
sudo minikube start
\end{lstlisting}

é‡è¦è¾“å‡ºï¼š

\begin{lstlisting}
ğŸ³  Version of container runtime is 18.09.2
âŒ›  Waiting for image downloads to complete ...
E0424 00:19:35.003745    1889 start.go:209] Error caching images:  Caching images for kubeadm: caching images: caching image /root/.minikube/cache/images/gcr.io/k8s-minikube/storage-provisioner_v1.8.1: fetching remote image: Get https://gcr.io/v2/: dial tcp 74.125.204.82:443: i/o timeout
âœ¨  Preparing Kubernetes environment ...
âŒ  Unable to load cached images: loading cached images: loading image /root/.minikube/cache/images/gcr.io/k8s-minikube/storage-provisioner_v1.8.1: stat /root/.minikube/cache/images/gcr.io/k8s-minikube/storage-provisioner_v1.8.1: no such file or directory
ğŸšœ  Pulling images required by Kubernetes v1.14.0 ...
ğŸš€  Launching Kubernetes v1.14.0 using kubeadm ... 
âŒ›  Waiting for pods: apiserver proxy etcd scheduler controller dns
ğŸ”‘  Configuring cluster permissions ...
ğŸ¤”  Verifying component health .....
ğŸ¤¹  Configuring local host environment ...

âš ï¸  The 'none' driver provides limited isolation and may reduce system security and reliability.
âš ï¸  For more information, see:
ğŸ‘‰  https://github.com/kubernetes/minikube/blob/master/docs/vmdriver-none.md

âš ï¸  kubectl and minikube configuration will be stored in /root
âš ï¸  To use kubectl or minikube commands as your own user, you may
âš ï¸  need to relocate them. For example, to overwrite your own settings:

    â–ª sudo mv /root/.kube /root/.minikube $HOME
    â–ª sudo chown -R $USER $HOME/.kube $HOME/.minikube

ğŸ’¡  This can also be done automatically by setting the env var CHANGE_MINIKUBE_NONE_USER=true
ğŸ’—  kubectl is now configured to use "minikube"
ğŸ„  Done! Thank you for using minikube!
\end{lstlisting}

ä¸‹é¢ç»™å‡ºé›†ç¾¤å¯åŠ¨ä¹‹åæœ¬æœºæ‰€è¿è¡Œçš„ docker å®¹å™¨åˆ—è¡¨ã€‚

\begin{lstlisting}
CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS               NAMES
5d416847c422        5cd54e388aba           "/usr/local/bin/kubeâ€¦"   20 hours ago        Up 20 hours                             k8s_kube-proxy_kube-proxy-qtctj_kube-system_ba4c62f4-65e3-11e9-9acd-3a4feb33d13b_0
be34a9157d37        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_kube-proxy-qtctj_kube-system_ba4c62f4-65e3-11e9-9acd-3a4feb33d13b_0
6c0e3702a706        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_coredns-fb8b8dccf-tfct6_kube-system_ba4c6fa2-65e3-11e9-9acd-3a4feb33d13b_0
46fb09b54279        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_coredns-fb8b8dccf-ssr52_kube-system_ba4bc787-65e3-11e9-9acd-3a4feb33d13b_0
fde495430bdf        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_storage-provisioner_kube-system_ba4780d4-65e3-11e9-9acd-3a4feb33d13b_0
05e94c674ce5        00638a24688b           "kube-scheduler --biâ€¦"   20 hours ago        Up 20 hours                             k8s_kube-scheduler_kube-scheduler-minikube_kube-system_58272442e226c838b193bbba4c44091e_0
0e0f32af6c4b        ecf910f40d6e           "kube-apiserver --adâ€¦"   20 hours ago        Up 20 hours                             k8s_kube-apiserver_kube-apiserver-minikube_kube-system_267a4c5b83c2f08d16cd0b2fb496fdf3_0
59a4d5ce55c5        2c4adeb21b4f           "etcd --advertise-clâ€¦"   20 hours ago        Up 20 hours                             k8s_etcd_etcd-minikube_kube-system_973c2fad42d1ca0c0cafe14fa28f9a70_0
ad0edb256af6        b95b1efa0436           "kube-controller-manâ€¦"   20 hours ago        Up 20 hours                             k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_6f22129755f0edc1e35623595e40aab2_0
cf7beb5a9f2b        119701e77cbc           "/opt/kube-addons.sh"    20 hours ago        Up 20 hours                             k8s_kube-addon-manager_kube-addon-manager-minikube_kube-system_0abcb7a1f0c9c0ebc9ec348ffdfb220c_0
218f0881a76a        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_kube-scheduler-minikube_kube-system_58272442e226c838b193bbba4c44091e_0
b04d338f0290        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_kube-apiserver-minikube_kube-system_267a4c5b83c2f08d16cd0b2fb496fdf3_0
f7a634bc0085        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_kube-controller-manager-minikube_kube-system_6f22129755f0edc1e35623595e40aab2_0
446a4cd0e374        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_kube-addon-manager-minikube_kube-system_0abcb7a1f0c9c0ebc9ec348ffdfb220c_0
e4d548c62aa5        k8s.gcr.io/pause:3.1   "/pause"                 20 hours ago        Up 20 hours                             k8s_POD_etcd-minikube_kube-system_973c2fad42d1ca0c0cafe14fa28f9a70_0
\end{lstlisting}

å› ä¸ºè€ƒè™‘åˆ°è¦åœ¨å®ä½“æœºï¼Œäº‘ç¯å¢ƒï¼Œè™šæ‹ŸåŒ–ç­‰å¤šå¤„è¿è¡Œï¼Œä¸ºäº†é˜²æ­¢è™šæ‹ŸåŒ–ç¯å¢ƒä¸‹ç¼ºå°‘åµŒå¥—è™šæ‹ŸåŒ–æ”¯æŒï¼Œæˆ‘ä»¬å…³é—­ minikube çš„ä¸€åˆ‡è™šæ‹Ÿæœºåç«¯ï¼Œè®¾ç½®ä¸º noneï¼Œå³ä½¿ç”¨æœ¬æœºè£¸æœºï¼Œå¹¶ä¸”ä½¿ç”¨ root ç”¨æˆ· (sudo) æ‰§è¡Œå‘½ä»¤ï¼Œä»è€Œæ»¡è¶³å‘ç³»ç»Ÿä¸­å®‰è£…è½¯ä»¶çš„æƒé™é™åˆ¶ã€‚è¿™ä¸€æ­¥å¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µè¿›è¡Œé€‰æ‹©ï¼Œé»˜è®¤é…ç½®çš„ virtualbox æ³›ç”¨æ€§è¾ƒå¥½ï¼Œåœ¨ Linux ç¯å¢ƒä¸‹ï¼Œkvm ä½œä¸ºåç«¯ä¹Ÿæ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºä½¿ç”¨ none è£¸æœºç¯å¢ƒéœ€è¦æœ¬æœºå…·æœ‰ docker ç¯å¢ƒï¼Œè¯»è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¸­å…·æœ‰å“ªäº›å·¥å…·è‡ªç”±é€‰æ‹©ã€‚

äº‹å®ä¸Šï¼Œminikube åŒæ—¶æ”¯æŒ Windowsï¼ŒmacOSï¼ŒLinux ä¸‰å¤§å¹³å°ï¼Œå› ä¸ºä¸»è¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­ï¼Œç³»ç»Ÿæœ¬æœºçš„æ“ä½œç³»ç»Ÿç¯å¢ƒæœ¬èº«ä¸è¢«ä¾èµ–ã€‚å‡ ä¹æ‰€æœ‰ä¸»æµçš„è™šæ‹Ÿæœºéƒ½è¢«æ”¯æŒï¼ŒåŒ…æ‹¬äº† KVM, VirtualBox, HyperV, VMWare Fusion ç­‰ã€‚

ä¸‹é¢ç»™å‡º Kubernetes é›†ç¾¤è¿è¡Œåçš„ dashboard æˆªå›¾ã€‚

\begin{figure}
    \includegraphics[width=0.8\linewidth]{dashboard-header.png}
    \caption{Kubernetes Dashboard}
\end{figure}

\begin{figure}
    \includegraphics[width=0.8\linewidth]{dashboard-pods.png}
    \caption{Dashboard Pods View}
\end{figure}

å°è¯•åœ¨æœ¬åœ° Kubernetes é›†ç¾¤ä¸­è¿è¡Œåº”ç”¨ï¼š

å›¾ä¸­å±•ç¤ºäº†å®¹å™¨ç¼–æ’ç³»ç»Ÿé¢†åŸŸçš„ Hello Worldï¼ŒWeb æœåŠ¡å™¨çš„å¯åŠ¨æµç¨‹ã€‚æˆ‘ä»¬åœ¨ç®¡ç†é¡µé¢å¡«å†™ nginx é•œåƒçš„

\begin{figure}
    \includegraphics[width=0.8\linewidth]{python-sets.png}
    \caption{Python Replica Set}
\end{figure}

% TODO

\subsection{Operator å¼€å‘}

æœ¬éƒ¨åˆ†è®²è¿°åœ¨å¼€å‘ Operator çš„è¿‡ç¨‹ï¼Œé‡åˆ°çš„é—®é¢˜ï¼Œè®¾è®¡æ€è·¯ä»¥åŠå…¶ä¸­çš„ç»†èŠ‚ã€‚

Kubernetes ç”Ÿæ€çš„ç»„ä»¶å¤šé‡‡ç”¨ Go è¯­è¨€å¼€å‘ï¼ŒOperator ä¹Ÿå¦‚æ­¤ã€‚

å¼€å‘ç¯å¢ƒæ–¹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ GoLand ä½œä¸º Go è¯­è¨€çš„å¼€å‘ IDEï¼Œä½¿ç”¨ gentoo Linux ä½œä¸ºå¼€å‘ç¯å¢ƒã€‚ä½¿ç”¨åµŒå¥—è™šæ‹ŸåŒ–çš„æ–¹å¼ï¼Œåœ¨ Linux è™šæ‹Ÿæœºä¸­è¿è¡Œ KVM è™šæ‹Ÿæœºä½œä¸º Kubernetes é›†ç¾¤çš„è¿è¡Œç¯å¢ƒã€‚

\subsubsection{æ¡†æ¶}

Operator SDK æä¾›äº†ä¸€ç§å¿«é€Ÿæ­å»º Kubernetes Operator çš„æ–¹æ³•ã€‚å¾ˆå®¹æ˜“æƒ³åˆ°ä¸ API å¯¹æ¥çš„ä¸€ä¸ªä¸“ç”¨è§’è‰²å½“ä¸­ä¼šæœ‰å¾ˆå¤šå†…å®¹å‡ ä¹å›ºå®šçš„æ¨¡æ¿ä»£ç ï¼ŒSDK æä¾›çš„å‘½ä»¤è¡Œå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿç”Ÿæˆè¿™éƒ¨åˆ†ä»£ç ã€‚

https://coreos.com/operators/ æ˜¯è¿™ä¸ªé¡¹ç›®çš„å®˜æ–¹ç½‘ç«™ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ä¸€äº›è¯´æ˜ã€‚æ€»çš„æ¥è®²ï¼ŒOperator æ˜¯ä¸€ç§æ‰“åŒ…ï¼Œéƒ¨ç½²å’Œç®¡ç† Kubernetes åº”ç”¨çš„æ–¹æ³•ã€‚Kubernetes åº”ç”¨å®šä¹‰ä¸ºéƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­å¹¶ä¸”ä½¿ç”¨ Kubernetes API å’Œ kubectl å·¥å…·ç®¡ç†çš„åº”ç”¨ã€‚ä¸ºäº†æœ€å¤§åŒ– Kubernetes çš„ä»·å€¼ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨è‡ªæ°ä¸”å¯è§£é‡Šçš„ API å¯¹è±¡æ¥æè¿°å’Œç®¡ç†åº”ç”¨ã€‚

\subsubsection{Custom Resource Definition}

\subsection{ç®—æ³•è®¾è®¡}

å¯¹äºä¸€ä¸ªé€šç”¨çš„è°ƒåº¦ç®—æ³•ï¼Œæˆ‘ä»¬å¾€å¾€å¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªèƒŒåŒ…é—®é¢˜çš„å»¶ä¼¸ã€‚æ‰€è°“èƒŒåŒ…é—®é¢˜ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬å…·æœ‰å¤šä¸ªèƒŒåŒ…ï¼Œæ¯ä¸ªèƒŒåŒ…èƒ½æ‰¿è½½ä¸€å®šé‡çš„é‡é‡ï¼ŒèƒŒåŒ…å½“ä¸­éœ€è¦å­˜æ”¾é‡é‡å„è‡ªä¸åŒçš„ç‰©å“ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªç¡®å®šçš„ç›®æ ‡ï¼Œå¦‚ä½¿ç”¨ç»™å®šçš„èƒŒåŒ…æ•°ç›®å’Œè§„æ ¼è£…ä¸‹çš„ç‰©å“é‡é‡ä¹‹å’Œæœ€å¤§ã€‚

å¯¹äºè°ƒåº¦ç®—æ³•æ¥è®²ï¼Œä¸è€ƒè™‘åŠ¨æ€æ”¹å˜é…ç½®çš„åœºæ™¯ä¸‹è°ƒåº¦åŠ¨ä½œè·¯å¾„çš„é—®é¢˜ï¼Œåˆ™å¯ä»¥ç®€åŒ–ä¸ºå¦‚ä¸‹ä¸€ä¸ªé—®é¢˜ï¼š

å¯¹äºå¼‚è´¨æ•°æ®å’Œè®¡ç®—é€»è¾‘çš„éƒ¨ç½²ï¼Œæˆ‘ä»¬ç§°å‘¼ä¸€ä»½æ•°æ®å’Œè®¡ç®—æ¨¡å‹ä¸€è‡´çš„å¤šå‰¯æœ¬ä¸ºä¸€ä¸ªåº”ç”¨(application)ï¼Œæ‰¿è½½å¤šä¸ªç›¸åŒåº”ç”¨çš„ä¸€ç»„è¿›ç¨‹å‰¯æœ¬ä¸ºé›†ç¾¤(cluster)ï¼Œå¯è§è¿™é‡Œçš„åº”ç”¨å°±æ˜¯â€œç‰©å“â€ï¼Œé›†ç¾¤å°±æ˜¯â€œèƒŒåŒ…â€ã€‚

æ¯ä¸ªåº”ç”¨æœ‰å¤šä¸ªä¸åŒç»´åº¦çš„èµ„æºï¼Œè¿™æ˜¯æ¯”èµ·ä¼ ç»Ÿçš„èƒŒåŒ…é—®é¢˜çš„å¤æ‚ä¹‹å¤„ï¼Œèµ„æºå¯ä»¥åŒ…æ‹¬ CPU èµ„æºï¼Œå†…å­˜ï¼Œç£ç›˜å­˜å‚¨ï¼Œç½‘ç»œå¸¦å®½ç­‰å¤šä¸ªç»´åº¦ã€‚æ˜“çŸ¥åœ¨æ»¡è¶³è¿™äº›è¦æ±‚ä¸‹çš„ä¼˜åŒ–é—®é¢˜æ˜¯ NP å®Œå…¨é—®é¢˜ã€‚è¿™æ„å‘³ç€

æˆ‘ä»¬éœ€è¦æä¾›çš„ç®—æ³•ï¼Œå³æ˜¯è¿™ä¸ªåœºæ™¯ä¸‹çš„æœ€ä¼˜åŒ–é—®é¢˜ã€‚éš¾ç‚¹åœ¨äºæˆ‘ä»¬ç”šè‡³éš¾ä»¥ç»™å‡ºæ¸…æ™°çš„æœ€ä¼˜åŒ–å®šä¹‰ã€‚åœ¨æˆ‘ä»¬çš„é—®é¢˜ä¸­ï¼Œâ€œèƒŒåŒ…â€çš„è§„æ ¼ï¼Œâ€œåº”ç”¨â€çš„è§„æ ¼

\section{é—®é¢˜ä¸å»ºè®®}

\section{å…¶ä»–}
